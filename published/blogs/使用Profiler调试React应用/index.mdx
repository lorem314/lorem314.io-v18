---
title: ä½¿ç”¨ Profiler è°ƒè¯• React åº”ç”¨
tags:
  - React
  - æ€§èƒ½ä¼˜åŒ–
  - Profiler
date: 2024-02-06
---

import Section from '@/components/elements/Section'

æœ¬æ–‡é€šè¿‡æ„å»ºä¸€ä¸ªç”¨æˆ·åˆ—è¡¨ Demoï¼Œæ¥è®²è§£å¦‚ä½•ä½¿ç”¨ React Profiler å·¥å…·æ¥æµ‹è¯• React é¡µé¢çš„æ€§èƒ½ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨`React.memo`å’Œ`React.useCallback`æ¥æé«˜æ€§èƒ½ã€‚

Demo çš„åˆæ¬¡å®ç°ï¼Œå°†ä¸ä¼šä½¿ç”¨ä»»ä½•æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œå¾—åˆ°é¡µé¢æ€§èƒ½æ•°æ®ï¼Œä¹‹åï¼Œé€šè¿‡ä½¿ç”¨ç¼“å­˜ç­–ç•¥ï¼Œå¾—åˆ°ä¼˜åŒ–åçš„æ€§èƒ½æ•°æ®ï¼Œå¯¹æ¯”å‰åæ€§èƒ½æ•°æ®ï¼Œè¯å®ä¼˜åŒ–ç­–ç•¥ç¡®å®æœ‰æ•ˆã€‚

<Section title="æ„å»ºé¡¹ç›®">

é€šè¿‡ random-user ç½‘ç«™æä¾›çš„ apiï¼Œæˆ‘ä»¬ä½¿ç”¨ fetch æ–¹æ³•æ¥è·å– 100 ä¸ªç”¨æˆ·ï¼Œå±•ç¤ºç”¨æˆ·å¤´åƒï¼Œç”¨æˆ·ä¿¡æ¯å’Œä¸€ä¸ªå…³æ³¨æŒ‰é’®ã€‚

ä½¿ç”¨ useState æ¥å­˜æ”¾ç”¨æˆ·æ•°ç»„ï¼ŒåŒæ ·ç”¨ useState æ¥å­˜å‚¨å·²å…³æ³¨çš„ç”¨æˆ·çš„ idï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œç”¨æ¥æ ¹æ®åå­—ç­›é€‰ç”¨æˆ·ï¼Œé¡µé¢æ ·å¼å¦‚ä¸‹ã€‚

![](/blogs/ä½¿ç”¨Profilerè°ƒè¯•Reactåº”ç”¨/react-profiler-001.jpg)

æœ¬æ–‡ä½¿ç”¨ create-react-app æ¥åˆå§‹åŒ–é¡¹ç›®

```shell
npx create-react-app debug-with-profiler
```

å®Œæˆåï¼Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹

```text
debug-with-profiler
â”œâ”€ node_modules
â”œâ”€ public
â”œâ”€ src
â”‚  â”œâ”€ components
â”‚  â”‚  â”œâ”€ api.js
â”‚  â”‚  â”œâ”€ FollowButton.jsx
â”‚  â”‚  â”œâ”€ User.jsx
â”‚  â”‚  â””â”€ UserList.jsx
â”‚  â”œâ”€ App.css
â”‚  â”œâ”€ App.jsx
â”‚  â”œâ”€ App.test.js
â”‚  â”œâ”€ index.css
â”‚  â”œâ”€ index.js
â”‚  â”œâ”€ logo.svg
â”‚  â”œâ”€ reportWebVital.js
â”‚  â””â”€ setupTests.js
â”œâ”€ .gitignore
â”œâ”€ package-lock.json
â”œâ”€ package.json
â””â”€ README.md
```

<Section title="API">

æ–°å»ºæ–‡ä»¶`api.js`ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª async å‡½æ•°ï¼Œé€šè¿‡ api è·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒæ—¶ä½¿ç”¨ count æ¥è®¾ç½®æƒ³è·å–çš„ç”¨æˆ·æ•°é‡ã€‚

```jsx
const getRandomUsers = async (count) => {
  const data = await fetch(`https://api.randomuser.me/?nat=US&results=${count}`)
  return await data.json()
}

export { getRandomUsers }
```

</Section>

<Section title="å…³æ³¨æŒ‰é’®">


```jsx
import React from "react"

const FollowButton = ({ isFollowing, onClick }) => {
  return (
    <button
      className={`follow-button ${isFollowing && "is-following"}`}
      onClick={onClick}
    >
      {isFollowing ? "å–æ¶ˆå…³æ³¨" : "å…³æ³¨"}
    </button>
  )
}

export default FollowButton
```

</Section>


<Section title="User ç»„ä»¶">

```jsx
import React from "react"

import FollowButton from "./FollowButton"

const User = ({ user, followingIds, handleClickFollowButton }) => {
  const isFollowing = followingIds.includes(user.login.uuid)
  return (
    <li className="user">
      <img width="72px" height="72px" src={user.picture.medium} alt="user-avatar" />
      <div className="user-info">
        <small>{user.login.uuid}</small>
        <div>
          Name : {user.name.title}. {user.name.first} {user.name.last}
        </div>
        <small>{user.email}</small>
      </div>
      <div className="actions">
        <FollowButton
          isFollowing={isFollowing}
          onClick={handleClickFollowButton(user.login.uuid)}
        />
      </div>
    </li>
  )
}

export default User
```

</Section>


<Section title="UserList ç»„ä»¶">

```jsx
import React from "react"

import User from "./User"

const UserList = ({
  users = [],
  searchText = "",
  followingIds = [],
  handleClickFollowButton = () => {},
}) => {
  return (
    <ul className="user-list">
      {users.length === 0 ? (
        <p>ç‚¹å‡»æŒ‰é’®è·å–ç”¨æˆ·</p>
      ) : (
        users
          .filter((user) => {
            if (searchText === "") return true
            return (
              user.name.first
                .toLowerCase()
                .includes(searchText.toLowerCase()) ||
              user.name.last.toLowerCase().includes(searchText.toLowerCase())
            )
          })
          .map((user) => {
            return (
              <User
                key={user.login.uuid}
                user={user}
                followingIds={followingIds}
                handleClickFollowButton={handleClickFollowButton}
              />
            )
          })
      )}
    </ul>
  )
}

export default UserList
```

</Section>


<Section title="App ç»„ä»¶">

```jsx
import React, { useState } from "react"

import { getRandomUsers } from "./components/api"
import UserList from "./components/UserList"
import "./App.css"

function App() {
  const [users, setUsers] = useState([])
  const [searchText, setSearchText] = useState("")
  const [followingIds, setFollowingIds] = useState([])

  const fetchUsers = () => {
    getRandomUsers(100).then((data) => {
      setUsers(data.results)
    })
  }

  const handleSearchTextChange = (event) => {
    setSearchText(event.target.value)
  }

  const handleClickFollowButton = (clickedId) => () => {
    console.log("clicked ", clickedId)
    followingIds.includes(clickedId)
      ? setFollowingIds(followingIds.filter((id) => id !== clickedId))
      : setFollowingIds([...followingIds, clickedId])
  }

  return (
    <div className="app">
      <h1>ä½¿ç”¨React Profileæ¥è°ƒè¯•æ€§èƒ½</h1>
      <button onClick={fetchUsers}>è·å–ç”¨æˆ·</button>
      <br />
      <input
        type="search"
        value={searchText}
        onChange={handleSearchTextChange}
      />
      <UserList
        users={users}
        searchText={searchText}
        followingIds={followingIds}
        handleClickFollowButton={handleClickFollowButton}
      />
    </div>
  )
}

export default App
```

</Section>

</Section>

<Section title="æµ‹è¯•æ€§èƒ½">

åˆ·æ–°é¡µé¢ï¼Œç‚¹å‡»è·å–ç”¨æˆ·ï¼Œæ¸²æŸ“äº† 100 åç”¨æˆ·ï¼Œå¼€å§‹ profilerï¼Œéšä¾¿ç‚¹å‡»å‡ ä¸ªç”¨æˆ·çš„å…³æ³¨æŒ‰é’®ï¼Œç‚¹å‡»è¿‡çš„ç”¨æˆ·çš„æŒ‰é’®æ–‡å­—ä»å…³æ³¨å˜ä¸ºå–æ¶ˆå…³æ³¨ï¼Œä»£è¡¨ç”¨æˆ· id ç¡®å®è¢«åŠ è¿›äº† followingIds æ•°ç»„é‡Œï¼Œåœæ­¢ profilerï¼Œå¾—åˆ°ç»“æœã€‚

![æ¸²æŸ“ç»“æœ](/blogs/ä½¿ç”¨Profilerè°ƒè¯•Reactåº”ç”¨/react-profiler-002.jpg)

æˆ‘ä¸€å…±ç‚¹å‡»äº† 5 ä¸ªç”¨æˆ·ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½ä¼šè§¦å‘ App ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ï¼Œprofiler çš„å³ä¸Šè§’æ ‡æœ‰`1/5`æ–‡å­—çš„å³è¾¹æœ‰ 5 ä¸ªå¸¦é¢œè‰²çš„æ–¹å—ï¼Œæ¯ä¸ªæ–¹å—ä»£è¡¨ä¸€æ¬¡æ¸²æŸ“ç»“æœï¼Œç‚¹å‡»åå¯åœ¨ä¸‹æ–¹æ˜¾ç¤ºæ¯æ¬¡æ¸²æŸ“çš„ç»„ä»¶ã€‚

ç‚¹å‡»ä¸‹æ–¹çš„æ ‡æœ‰ App çš„é•¿æ¡ï¼Œæœ€å³è¾¹çš„æ ä¸­å¾—åˆ°è¿™ 5 æ¬¡æ¸²æŸ“ä¸­ï¼ŒApp ç»„ä»¶çš„æ¸²æŸ“ç”¨æ—¶ï¼Œ5 æ¬¡ä¸­æœ€æ…¢çº¦ä¸º 40 æ¯«ç§’ï¼Œæœ€å¿«çº¦ä¸º 22 æ¯«ç§’ã€‚

![æ¸²æŸ“ç»“æœ](/blogs/ä½¿ç”¨Profilerè°ƒè¯•Reactåº”ç”¨/react-profiler-003.jpg)

é»„è‰²æ¡ä¸º UserList ç»„ä»¶ï¼Œæ¸²æŸ“ç”¨æ—¶çº¦ä¸º 37 æ¯«ç§’ï¼Œå†å¾€ä¸‹æ¯ä¸ªå°å—æ˜¯ User ç»„ä»¶ï¼Œæœ€ä¸‹é¢æ˜¯ FollowButton ç»„ä»¶ã€‚User ç»„ä»¶çš„é•¿æ¡é¢œè‰²ä¸ºæµ…ç»¿è‰²ï¼Œå‡ºç°äº†å¾ˆå¤šæ¬¡ï¼ˆ100 æ¬¡ï¼‰ï¼Œä»£è¡¨æ¯æ¬¡ App ç»„ä»¶é‡æ–°æ¸²æŸ“åï¼Œæ¯ä¸ª User ç»„ä»¶ä¹Ÿéƒ½è§¦å‘äº†é‡æ–°æ¸²æŸ“ã€‚

ä½†æˆ‘ä»¬åªç‚¹å‡»äº† 5 ä¸ªç”¨æˆ·ï¼Œé€»è¾‘ä¸Šæ¥è¯´ï¼Œéœ€è¦æ”¹åŠ¨çš„åªåº”è¯¥æ˜¯è¿™ 5 ä¸ªç”¨æˆ·ï¼Œå…¶ä»–ç”¨æˆ·çš„ User ç»„ä»¶ä¸éœ€è¦è·Ÿç€æ¸²æŸ“ï¼Œè¿™æ­£æ˜¯æ‰€è°“çš„éå¿…è¦æ¸²æŸ“(uncessary rendering)ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥æ¥é¿å…è¿™ç§æƒ…å†µã€‚

</Section>

<Section title="å®æ–½ä¼˜åŒ–">

é¦–å…ˆï¼Œæœ€éœ€è¦ä¼˜åŒ–çš„å°±æ˜¯ User ç»„ä»¶çš„æ¸²æŸ“ï¼Œç‚¹å‡»æŸä¸€ä¸ª User ç»„ä»¶é‡Œå…³æ³¨æŒ‰é’®åï¼Œæ‰€æœ‰çš„ User ç»„ä»¶éƒ½ä¼šè·Ÿç€æ›´æ–°ï¼Œå¾ˆæ˜¾ç„¶å…¶ä»– 99 ä¸ªç”¨æˆ·æ²¡æœ‰å¿…è¦è·Ÿç€æ›´æ–°ã€‚

ç¬¬ä¸€ä¸ªæƒ³æ³•å°±æ˜¯ç”¨ React.memo æŠŠ User ç»„ä»¶åœ¨å¯¼å‡ºæ—¶åŒ…èµ·æ¥ï¼Œåƒè¿™æ ·ï¼š

```jsx
export default React.memo(User)
```

è¿™æ ·èƒ½ä¿è¯ï¼ŒUser ç»„ä»¶çš„ props çš„å€¼å’Œä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶ç›¸æ¯”ï¼Œè‹¥æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œç›´æ¥ä½¿ç”¨ä¸Šä¸€æ¬¡çš„æ¸²æŸ“ç»“æœï¼Œé¿å…é‡æ–°æ¸²æŸ“ï¼Œè€Œå®é™…æ­£æ˜¯å¦‚æ­¤ï¼Œå…¶ä»– 99 ä¸ª User ç»„ä»¶çš„ props éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå”¯ä¸€å˜åŒ–çš„å°±æ˜¯ç‚¹å‡»äº†å…³æ³¨æŒ‰é’®çš„ User ç»„ä»¶çš„ isFollowing ç”± false å˜ä¸ºäº† trueã€‚

æ­¤æ—¶ä½ å¯ä»¥å†é‡æ–°æµ‹è¯•ä¸€éæ¸²æŸ“æ€§èƒ½ï¼Œç»“æœå¯èƒ½å¹¶ä¸ä¼šå¾ˆç†æƒ³ã€‚

![æ¸²æŸ“ç»“æœ](/blogs/ä½¿ç”¨Profilerè°ƒè¯•Reactåº”ç”¨/react-profiler-004.jpg)

æ¯æ¬¡æ¸²æŸ“è¿˜éƒ½æ˜¯ä¿æŒå† 20 æ¯«ç§’ä¹‹ä¸Šã€‚

æœ‰ä¸€ç¯‡åšå®¢ä¸­æœ‰æåˆ°è¿‡ï¼Œä½¿ç”¨ä¼˜åŒ–ç­–ç•¥æ—¶è¦è°¨æ…ï¼Œé”™è¯¯åœ°å®æ–½ä¼˜åŒ–ç­–ç•¥æœ‰æ—¶å¹¶ä¸èƒ½å¸¦æ¥å¥½å¤„ï¼Œåè€Œä¼šé™ä½æ€§èƒ½ã€‚

å›çœ‹ User ç»„ä»¶ï¼Œä¼ å…¥çš„ props æœ‰ 3 ä¸ªï¼š

- user
- followingIds
- handleClickFollowButton

user å˜é‡æ˜¯ users æ•°ç»„é€šè¿‡ map éå†è·å¾—çš„ï¼Œå†é€šè¿‡ fetchUsers å‡½æ•°è·å–è¿‡ 100 ä¸ªç”¨æˆ·ä¿¡æ¯åï¼Œusers æ•°ç»„ä¸ä¼šå‘ç”Ÿæ”¹åŠ¨ï¼Œæ•…éå†è·å¾—çš„ user ä¹Ÿä¸ä¼šæ”¹åŠ¨ï¼Œuser çš„å€¼åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ä¸­æ˜¯ä¿æŒä¸å˜çš„ã€‚

followingIds æ•°ç»„ï¼Œä» App ç»„ä»¶ä¸€è·¯ä¼ ä¸‹æ¥ï¼Œæ¯å…³æ³¨ä¸€ä¸ªç”¨æˆ·ï¼Œå°±æŠŠè¯¥ç”¨æˆ·çš„ user.login.uuid çš„å€¼æ”¾å…¥å…¶ä¸­ï¼Œæ‰€ä»¥è¯¥æ•°ç»„åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ä¸­éƒ½æ˜¯ä¼šå˜åŒ–çš„ã€‚

followingIds æ•°ç»„ç”¨äºè®¡ç®—è¯¥æ˜¯å¦å…³æ³¨è¿‡è¯¥ç”¨æˆ·ï¼Œä»¥æ­¤æ¥åŒºåˆ†æ˜¾ç¤ºæŒ‰é’®ä¸­çš„æ–‡å­—ã€‚æˆ‘ä»¬å¯ä»¥ä¸æŠŠ followingIds ä¼ é€’åˆ° User ç»„ä»¶ä¸­ï¼Œåœ¨ UserList ä¸­å¯¹ users è¿›è¡Œ map æ—¶å°±è®¡ç®—å¥½ï¼ŒisFollowing çš„å€¼ã€‚

```jsx
const UserList = ({
  users = [],
  searchText = "",
  followingIds = [],
  handleClickFollowButton = () => {},
}) => {
  return (
    <ul className="user-list">
      {users.length === 0 ? (
        <p>ç‚¹å‡»æŒ‰é’®è·å–ç”¨æˆ·</p>
      ) : (
        users
          .filter((user) => {
            if (searchText === "") return true
            return (
              user.name.first
                .toLowerCase()
                .includes(searchText.toLowerCase()) ||
              user.name.last.toLowerCase().includes(searchText.toLowerCase())
            )
          })
          .map((user) => {
            const isFollowing = followingIds.includes(user.login.uuid)
            return (
              <User
                key={user.login.uuid}
                user={user}
                isFollowing={isFollowing}
                handleClickFollowButton={handleClickFollowButton}
              />
            )
          })
      )}
    </ul>
  )
}
```

åŒæ—¶å°† User ç»„ä»¶ä¸­æ¥æ”¶çš„ followingIds å‚æ•°æ”¹ä¸º isFollowingï¼Œæ¥æ”¶çš„ isFollowing ç›´æ¥ä¼ å…¥åˆ° FollowButton ç»„ä»¶ã€‚

æ­¤æ—¶ï¼ŒisFollowing åœ¨ User ç»„ä»¶æ¸²æŸ“å‰å°±å·²ç»è®¡ç®—å¥½äº†ï¼Œå…¶ä½™ 99 ä¸ªç”¨æˆ·åœ¨é‡æ–°æ¸²æŸ“æ—¶è¯¥å€¼ä»ä¼šä¸º falseã€‚

æœ€åæ˜¯ handleClickFollowButtonï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼•ç”¨ï¼Œåœ¨ç»„ä»¶ä¸­å®šä¹‰çš„å‡½æ•°åœ¨æ¯æ¬¡ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶éƒ½ä¼šé‡æ–°ç”Ÿæˆï¼Œè¿™ä¹Ÿæ­£æ˜¯`()â‡’{} !== ()â‡’{}`çš„åŸå› ã€‚

handleClickFollowButton æ˜¯åœ¨ App ç»„ä»¶ä¸­å®šä¹‰çš„ï¼Œæ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œreact ä¸ºé¿å…å‡½æ•°åœ¨é‡æ–°æ¸²æŸ“æ—¶é‡æ–°æ„å»ºï¼Œç‰¹æ„å‡†å¤‡äº† React.useCallback å‡½æ•°ã€‚

å’Œ useEffect çš„å‚æ•°ç›¸åŒï¼ŒuseCallback ä¹Ÿæ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°å’Œä¸€ä¸ªä¾èµ–æ•°ç»„ï¼ŒuseCallback å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯è¯¥å›è°ƒå‡½æ•°æœ¬èº«ï¼Œåªæœ‰åœ¨å’Œä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶ä¾èµ–æ•°ç»„ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è¿”å›è¯¥å›è°ƒå‡½æ•°ã€‚

åŒæ—¶ handleClickFollowButton å‡½æ•°åœ¨æ‰§è¡Œä¸­æ¶‰åŠåˆ°äº† followingIds æ•°ç»„ï¼Œéœ€è¦å°† followingIds æ·»åŠ åˆ° useCallback çš„ä¾èµ–æ•°ç»„ä¸­ï¼Œå¦åˆ™ react ä¼šæç¤ºä»¥ä¸‹è­¦å‘Šï¼š

React Hook useCallback has a missing dependency: 'followingIds'. Either include it or remove the dependency array. You can also do a functional update 'setFollowingIds(f => ...)' if you only need 'followingIds' in the 'setFollowingIds' call react-hooks/exhaustive-deps

ç„¶è€Œä¸æ·»åŠ çš„è¯ï¼Œæˆ‘ä»¬çš„ app ä¹Ÿä¸ä¼šæ­£å¸¸æ‰§è¡Œï¼Œç”±äº react ç»„ä»¶ä¸¥é‡ä¾èµ–äºé—­åŒ…ï¼Œæ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶ï¼Œå‘ç”Ÿæ”¹åŠ¨çš„ useState çš„å€¼éƒ½ä¼šæ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„å˜é‡ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ react æ”¹å˜ state æ—¶éœ€è¦ç”¨åˆ° filterã€map ç­‰ä¼šè¿”å›æ–°å¼•ç”¨çš„å‡½æ•°ï¼Œè€Œé pushã€shift å’Œ forEach ç­‰ç›´æ¥åœ¨åŸæ•°ç»„ä¸Šåšæ”¹åŠ¨çš„å‡½æ•°ã€‚

å¦‚æœä¸æ·»åŠ ï¼Œæˆ‘ä»¬çš„ app ä¼šæœ‰ä»¥ä¸‹è¯¡å¼‚çš„è¡Œä¸ºï¼šç¬¬ä¸€æ¬¡ç‚¹å‡»å…³æ³¨æŒ‰é’®ï¼Œè¢«ç‚¹å‡»çš„ç”¨æˆ·çš„æŒ‰é’®æ–‡å­—ç”±å…³æ³¨å˜ä¸ºå–æ¶ˆå…³æ³¨ï¼Œä»£è¡¨æˆåŠŸå…³æ³¨äº†è¯¥ç”¨æˆ·ï¼›ç¬¬äºŒæ¬¡ç‚¹å‡»å¦å¤–ä¸€ä¸ªç”¨æˆ·çš„å…³æ³¨æŒ‰é’®æ—¶ï¼Œç¬¬ä¸€æ¬¡ç‚¹å‡»çš„ç”¨æˆ·çš„æŒ‰é’®å˜å›äº†å…³æ³¨ï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»çš„ç”¨æˆ·çš„æŒ‰é’®å˜æˆäº†å–æ¶ˆå…³æ³¨ï¼Œå°±å¥½åƒæˆ‘ä»¬ä»æœªå…³æ³¨è¿‡ç¬¬ä¸€ä½ç”¨æˆ·ä¸€æ ·ã€‚

è¿™æ˜¯å› ä¸ºï¼Œç”±äº useCallback æ²¡æœ‰å°† followingIds æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ŒuseCallback å‡½æ•°åªä¼šåœ¨ App ç»„ä»¶åˆæ¬¡æ¸²æŸ“æ—¶å°†å›è°ƒå‡½æ•°è¿”å›ç»™ handleClickFollowButtonï¼Œæ­¤æ—¶çš„ followingIds æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼›ç‚¹å‡»äº†æŒ‰é’®ä¹‹åï¼Œä¸‹ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼ŒuseCallback çš„ä¾èµ–æ•°ç»„ä¸ºç©ºï¼Œè¿˜å°†ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„å›è°ƒå‡½æ•°èµ‹å€¼ç»™ handleClickFollowButtonï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä¸­çš„ followingIdsï¼ˆç©ºæ•°ç»„ï¼‰çš„å€¼ï¼Œä»ç„¶å¯ä»¥åœ¨ handleClickFollowButton ä¸­è®¿é—®å¾—åˆ°ï¼Œæ‰€ä»¥ï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œæ˜¯å°†ç¬¬äºŒæ¬¡ç‚¹å‡»çš„ id æ·»åŠ åˆ°ç©ºæ•°ç»„ä¸­ï¼Œå¾—åˆ°é•¿åº¦ä¸º 1 çš„æ•°ç»„ï¼Œèµ‹å€¼ç»™äº†ç¬¬äºŒæ¬¡æ¸²æŸ“ä¸­çš„ followingIdsã€‚

```jsx
const handleClickFollowButton = useCallback(
  (clickedId) => () => {
    followingIds.includes(clickedId)
      ? setFollowingIds(followingIds.filter((id) => id !== clickedId))
      : setFollowingIds([...followingIds, clickedId])
  },
  [followingIds] // highlight-line
)
```

å°† followingIds æ·»åŠ åˆ° useCallback çš„ä¾èµ–æ•°ç»„ä¸­åï¼Œæˆ‘ä»¬å†æ¥æµ‹è¯•ä»¥ä¸‹æ€§èƒ½ã€‚

![æ¸²æŸ“ç»“æœ](/blogs/ä½¿ç”¨Profilerè°ƒè¯•Reactåº”ç”¨/react-profiler-005.jpg)

å°†æ¸²æŸ“é™åˆ°äº† 20 æ¯«ç§’ä»¥ä¸‹ã€‚

æˆ‘ä»¬å†æ¥ä»”ç»†æƒ³ä¸€æƒ³ ğŸ¤”ï¼Œæ¯æ¬¡ç‚¹å‡»æŒ‰é’®åï¼ŒfollowingIds çš„å€¼å¿…ç„¶ä¼šæ”¹å˜ï¼Œå› ä¸ºç‚¹å‡»äº‹ä»¶å°† user.login.uuid æ·»åŠ è¿›äº†è¯¥æ•°ç»„ï¼Œæ‰€ä»¥ App ç»„ä»¶åœ¨æ¸²æŸ“é‡æ–°æ¸²æŸ“æ—¶ï¼ŒuseCallback è¿˜æ˜¯ä¼šç”±äº followingIds å€¼çš„æ”¹å˜è€Œé‡æ–°è¿”å›å›è°ƒå‡½æ•°ï¼ŒhandleClickFollowButton åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ä¸­çš„å€¼è¿˜æ˜¯ä¸åŒçš„ã€‚

æˆ‘ä»¬è¿˜èƒ½å¦‚ä½•è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ

useState å‡½æ•°è¿”å›çš„ setter å‡½æ•°ï¼Œè¿˜å¯ä»¥ä¼ å…¥å‡½æ•°ï¼Œè¿›è¡ŒçŠ¶æ€å˜åŒ–ã€‚

```jsx
const [count, setCount] = useState(0)

setCount((prevCount) => {
  return prevCount + 1
})
```

ä¼ å…¥åˆ° setter ä¸­çš„å‡½æ•°çš„è¿”å›å€¼ï¼Œä¼šä½œä¸ºä¸‹ä¸€æ¬¡çŠ¶æ€çš„ç»“æœä½¿ç”¨ã€‚

```js
const handleClickFollowButton = useCallback(
  (clickedId) => () => {
    // highlight-start
    setFollowingIds((prevFollowingIds) => {
      return prevFollowingIds.includes(clickedId)
        ? prevFollowingIds.filter((id) => id !== clickedId)
        : [...prevFollowingIds, clickedId]
    })
    // highlight-end
  },
  []
)
```

é€šè¿‡ä½¿ç”¨å‡½æ•°çš„æ–¹å¼ï¼Œå…ˆåˆ¤æ–­ä¸Šä¸€æ¬¡çš„ followingIds æ•°ç»„â€”â€”prevFollowingIds ä¸­æ˜¯å¦å«æœ‰è¢«ç‚¹å‡»çš„ç”¨æˆ·çš„ idï¼Œæ ¹æ®ä¸åŒæƒ…å†µï¼Œåˆ†åˆ«è¿”å›ç§»é™¤æˆ–æ·»åŠ åçš„æ–°æ•°ç»„ï¼Œæ­¤æ—¶ useCallback å‡½æ•°ä¸­åªæ¶‰åŠåˆ°äº†ç”± useState å‡½æ•°è¿”å›çš„ setFollowingIds å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œå¯ä»¥å°†ä¾èµ–æ•°ç»„ä¸­çš„ followingIds åˆ é™¤äº†ï¼Œæ­¤æ—¶ï¼ŒhandleClickFollowButton å‡½æ•°åªä¼šåœ¨åˆæ¬¡æ¸²æŸ“è¢« useCallback å‡½æ•°çš„è¿”å›ç»“æœèµ‹å€¼ï¼Œä¹‹åçš„é‡æ–°æ¸²æŸ“ä¸­ä¸ä¼šå†æ¬¡è¢«èµ‹å€¼ã€‚

åœ¨æ¥æµ‹è¯•æ€§èƒ½ï¼Œå‡ä¿æŒåœ¨ 5 æ¯«ç§’ä¹‹å†…ã€‚

![æ¸²æŸ“ç»“æœ](/blogs/ä½¿ç”¨Profilerè°ƒè¯•Reactåº”ç”¨/react-profiler-006.jpg)

</Section>

<Section title="å‚è€ƒæ–‡ç« ">

- https://dmitripavlutin.com/use-react-memo-wisely/#3-when-to-avoid-reactmemo

</Section>
